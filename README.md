# ğŸ”— Suxia Short Link (D1 Ultimate Edition)

> ä¸€ä¸ªåŸºäº **Cloudflare Workers** + **D1 SQL Database**
> æ„å»ºçš„ä¼ä¸šçº§é«˜æ€§èƒ½çŸ­é“¾æ¥ç³»ç»Ÿã€‚\
> **æ— éœ€æœåŠ¡å™¨ Â· æ¯æ—¥ 10 ä¸‡+ å†™å…¥é¢åº¦ Â· é“¶è¡Œçº§å®‰å…¨ Â· æ·±åº¦æ•°æ®ç»Ÿè®¡**

![License](https://img.shields.io/badge/license-MIT-blue.svg)
![Platform](https://img.shields.io/badge/platform-Cloudflare%20Workers-orange.svg)
![Database](https://img.shields.io/badge/database-Cloudflare%20D1-red.svg)

------------------------------------------------------------------------

## ğŸ“– é¡¹ç›®ä»‹ç»

Suxia Short Link æ˜¯ä¸€ä¸ªå®Œå…¨è¿è¡Œåœ¨ Cloudflare è¾¹ç¼˜ç½‘ç»œä¸Šçš„ Serverless
çŸ­é“¾æ¥ç”Ÿæˆä¸ç®¡ç†ç³»ç»Ÿã€‚

æœ¬é¡¹ç›®é‡‡ç”¨ **å•æ–‡ä»¶æ¶æ„ (Single File Architecture)**ï¼Œå‰ç«¯ UI ä¸åç«¯ API
å®Œæ•´é›†æˆåœ¨åŒä¸€ä¸ª Worker ä¸­ï¼Œä¸ä¾èµ–ä»»ä½•æœåŠ¡å™¨ã€‚

### âœ¨ æ ¸å¿ƒç‰¹æ€§

-   **âš¡ï¸ ç”Ÿäº§çº§æ€§èƒ½**ï¼šä¾æ‰˜ Cloudflare å…¨çƒè¾¹ç¼˜ç½‘ç»œï¼Œæ¯«ç§’çº§è·³è½¬ã€‚
-   **ğŸ’¾ æµ·é‡å­˜å‚¨**ï¼šD1 SQL å…è´¹ç‰ˆæ”¯æŒ **10 ä¸‡å†™å…¥ + 500 ä¸‡è¯»å–/å¤©**ã€‚
-   **ğŸ“± å…¨ç«¯é€‚é…**
    -   PCï¼šè¡¨æ ¼ç®¡ç† + ç‚¹å‡»æ’åº\
    -   æ‰‹æœºï¼šå¡ç‰‡å¼å¸ƒå±€ + å¤§æŒ‰é’®æ“ä½œ
-   **ğŸ›¡ï¸ é“¶è¡Œçº§å®‰å…¨**
    -   Header é‰´æƒï¼ˆé¿å…å¯†ç å‡ºç°åœ¨ URLï¼‰
    -   å…¨å±€ HTML è½¬ä¹‰ï¼ˆé˜² XSSï¼‰
    -   é¢„ç¼–è¯‘ SQLï¼ˆé˜²æ³¨å…¥ï¼‰
-   **ğŸ” å¼ºå¤§ç®¡ç†åå°**
    -   æœç´¢ã€æ’åºã€æŒ‰å¹´ä»½/æœˆä»½ç­›é€‰
    -   ä¿®æ”¹å¤‡æ³¨ã€æŸ¥çœ‹è¯¦ç»†è®¿å®¢ç»Ÿè®¡
-   **ğŸ“Š æ·±åº¦ç»Ÿè®¡**
    -   ä½¿ç”¨ç¬¬ä¸‰æ–¹é«˜ç²¾åº¦ IP åº“ï¼Œå®šä½åˆ° **å›½å®¶-åŸå¸‚ï¼ˆä¸­æ–‡ï¼‰**
    -   åŒ IP å¤šæ¬¡è®¿é—®è‡ªåŠ¨èšåˆï¼Œå¹¶å±•ç¤ºæ—¶é—´è½¨è¿¹

------------------------------------------------------------------------

## ğŸ› ï¸ éƒ¨ç½²æ•™ç¨‹ï¼ˆWeb Dashboard ç‰ˆï¼‰

æ— éœ€æœ¬åœ°å¼€å‘ï¼Œåªéœ€æµè§ˆå™¨å³å¯åœ¨ 5 åˆ†é’Ÿå®Œæˆéƒ¨ç½²ã€‚

------------------------------------------------------------------------

### ç¬¬ä¸€æ­¥ï¼šå‡†å¤‡

1.  ç™»å½• Cloudflareï¼šhttps://dash.cloudflare.com\
2.  ç¡®ä¿åŸŸåå·²æ‰˜ç®¡è‡³ Cloudflare

------------------------------------------------------------------------

### ç¬¬äºŒæ­¥ï¼šåˆ›å»º D1 æ•°æ®åº“

1.  æ‰“å¼€ **Workers & Pages â†’ D1 SQL Database**
2.  ç‚¹å‡» **Create**ï¼Œå‘½åä¸º `link-db`
3.  æ‰“å¼€æ•°æ®åº“ â†’ è¿›å…¥ **Console**
4.  ä¾æ¬¡æ‰§è¡Œ 3 æ¡ SQLï¼ˆå¿…é¡»åˆ†å¼€ï¼‰

#### 1. åˆ›å»ºé“¾æ¥è¡¨

``` sql
CREATE TABLE IF NOT EXISTS links (
    id TEXT PRIMARY KEY,
    url TEXT NOT NULL,
    note TEXT,
    created_at INTEGER
);
```

#### 2. åˆ›å»ºæ—¥å¿—è¡¨

``` sql
CREATE TABLE IF NOT EXISTS visits (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    link_id TEXT,
    ip TEXT,
    region TEXT,
    created_at INTEGER
);
```

#### 3. åˆ›å»ºç´¢å¼•

``` sql
CREATE INDEX IF NOT EXISTS idx_visits_link_id ON visits(link_id);
```

------------------------------------------------------------------------

### ç¬¬ä¸‰æ­¥ï¼šåˆ›å»º Worker

1.  æ‰“å¼€ **Workers & Pages â†’ Overview**
2.  Create Application â†’ Create Worker
3.  å‘½åä¸º `short-link` â†’ Deploy

------------------------------------------------------------------------

### ç¬¬å››æ­¥ï¼šé…ç½®ç¯å¢ƒå˜é‡ï¼ˆå¿…é¡»ï¼‰

è·¯å¾„ï¼š**Worker â†’ Settings â†’ Variables**

#### 1. Environment Variables

  KEY                VALUE
  ------------------ --------
  `ADMIN_USER`       admin
  `ADMIN_PASSWORD`   å¼ºå¯†ç 

#### 2. D1 Database Bindings

-   Add Binding
    -   Nameï¼š`DB`ï¼ˆå¿…é¡»å¤§å†™ï¼‰
    -   é€‰æ‹©æ•°æ®åº“ï¼š`link-db`

âš ï¸ æœ€åç‚¹å‡» **Save and deploy**

------------------------------------------------------------------------

### ç¬¬äº”æ­¥ï¼šéƒ¨ç½²ä»£ç 

1.  æ‰“å¼€ Worker â†’ **Code**
2.  åˆ é™¤é»˜è®¤ä»£ç 
3.  ç²˜è´´ `worker.js`ï¼ˆV29.1ï¼‰
4.  ç‚¹å‡» **Deploy**

------------------------------------------------------------------------

### ç¬¬å…­æ­¥ï¼šç»‘å®šåŸŸå

1.  æ‰“å¼€ **Settings â†’ Triggers**
2.  Add Custom Domain\
    ä¾‹å¦‚ï¼š`link.example.com`

------------------------------------------------------------------------

## ğŸ“– ä½¿ç”¨æŒ‡å—

### ğŸ  å‰ç«¯ï¼ˆç”¨æˆ·ï¼‰

è®¿é—®é¦–é¡µï¼ˆå¦‚ `https://link.example.com`ï¼‰ï¼š

-   è¾“å…¥é•¿é“¾æ¥ï¼ˆå¿…é¡»å« http:// æˆ– https://ï¼‰
-   ä¸€é”®ç”ŸæˆçŸ­é“¾
-   æ”¯æŒå¤åˆ¶

------------------------------------------------------------------------

### âš™ï¸ åå°ï¼ˆç®¡ç†ç«¯ï¼‰

è®¿é—®ï¼š`https://link.example.com/admin`

åŠŸèƒ½ï¼š

-   æœç´¢ï¼ˆåŸå§‹é“¾æ¥ + å¤‡æ³¨ï¼‰
-   æŒ‰å¹´ä»½/æœˆç­›é€‰
-   æŒ‰åˆ›å»ºæ—¶é—´/è®¿é—®æ¬¡æ•°æ’åº
-   ğŸ“ ä¿®æ”¹å¤‡æ³¨
-   ğŸ“‰ æŸ¥çœ‹è®¿é—®ç»Ÿè®¡è¯¦æƒ…

------------------------------------------------------------------------

## ğŸ’» API æ–‡æ¡£ï¼ˆå¼€å‘è€…ï¼‰

ç®¡ç†æ¥å£å‡éœ€ **Header é‰´æƒ**ï¼š

  Header           å†…å®¹
  ---------------- --------------------------------------
  `X-Auth-User`    ç”¨æˆ·å
  `X-Auth-Key`     å¯†ç 
  `Content-Type`   application/jsonï¼ˆPOST/DELETE éœ€å¸¦ï¼‰

------------------------------------------------------------------------

### 1. åˆ›å»ºçŸ­é“¾ï¼ˆå…¬å¼€ï¼‰

    GET /api/create?url={long_url}

ç¤ºä¾‹ï¼š

    https://your-domain.com/api/create?url=https://google.com

------------------------------------------------------------------------

### 2. è·å–åˆ—è¡¨

``` bash
curl "https://your-domain.com/api/admin/list?limit=10&offset=0"   -H "X-Auth-User: admin"   -H "X-Auth-Key: your_password"
```

------------------------------------------------------------------------

### 3. åˆ é™¤é“¾æ¥

``` bash
curl -X DELETE "https://your-domain.com/api/admin/delete?id=xxxx"   -H "X-Auth-User: admin"   -H "X-Auth-Key: your_password"
```

------------------------------------------------------------------------

## â“ å¸¸è§é—®é¢˜ï¼ˆQ&Aï¼‰

### Q: IP ä½ç½®ä¸ºä»€ä¹ˆæ›´ç²¾å‡†ï¼Ÿ

A: ä½¿ç”¨é«˜ç²¾åº¦æ¥å£ï¼ˆip-api.comï¼‰ï¼Œå¯å®šä½åˆ°åŸå¸‚å¹¶è¾“å‡ºä¸­æ–‡ã€‚

### Q: SQL æ§åˆ¶å°æŠ¥é”™ "The request is malformed"ï¼Ÿ

A: Cloudflare æ§åˆ¶å° Bugï¼Œè¯·ç¡®ä¿ **æ¯æ¬¡åªæ‰§è¡Œ 1 æ¡ SQL**ã€‚

### Q: æ‰“å¼€åå°å‡ºç° 500ï¼Ÿ

A: é€šå¸¸æ˜¯æœªç»‘å®š D1 æ•°æ®åº“ã€‚æ£€æŸ¥ DB ç»‘å®šæ˜¯å¦æ­£ç¡®ã€‚

------------------------------------------------------------------------

## ğŸ“‚ é¡¹ç›®ç»“æ„

    worker.js
    â”œâ”€â”€ CONFIG
    â”œâ”€â”€ html
    â”‚   â”œâ”€â”€ CSS
    â”‚   â”œâ”€â”€ JS
    â”‚   â””â”€â”€ HTML
    â””â”€â”€ fetch()
        â”œâ”€â”€ è·¯ç”±åˆ†å‘
        â”œâ”€â”€ é‰´æƒ
        â””â”€â”€ æ•°æ®åº“æ“ä½œ

------------------------------------------------------------------------

## ğŸ“„ License

MIT License
